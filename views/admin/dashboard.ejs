<!DOCTYPE html>
<html>
<head>
    <title>Painel Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .qrcode-container {
            width: 250px;
            height: 250px;
            margin: 0 auto;
        }
        .qrcode-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto p-4">
        <!-- Cabeçalho -->
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-2xl font-bold text-gray-800">
                <i class="fas fa-cog mr-2 text-blue-500"></i>Painel Administrativo
            </h1>
            <a href="/" class="text-blue-500 hover:text-blue-700">
                <i class="fas fa-arrow-left mr-1"></i>Voltar
            </a>
        </div>

        <!-- Seção do QR Code -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">
                <i class="fas fa-qrcode mr-2 text-green-500"></i>Conexão WhatsApp
            </h2>

            <div id="connection-status" class="mb-4 p-3 rounded-lg bg-yellow-100 text-yellow-800 text-center">
                <i class="fas fa-circle-notch animate-spin mr-2"></i> Aguardando QR Code...
            </div>

            <div class="qrcode-container bg-white p-4 border-2 border-dashed border-gray-300 rounded-lg mb-4">
                <img id="qrcode" src="" alt="QR Code para conexão" class="hidden">
            </div>

            <div class="text-center text-sm text-gray-500">
                Escaneie este QR Code no WhatsApp > Dispositivos conectados
            </div>
        </div>

        <!-- Resto do seu conteúdo admin... -->

        <script src="/socket.io/socket.io.js"></script>
        <script>
            // Conecta ao namespace /admin
            const socket = io('/admin', {
                reconnection: true,
                reconnectionAttempts: Infinity,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000
            });

            // Logs para debug
            socket.on('connect', () => {
                console.log('Conectado ao servidor Socket.IO');
                document.getElementById('connection-status').innerHTML = 
                    '<i class="fas fa-circle-notch animate-spin mr-2"></i> Conectado ao servidor - aguardando QR Code...';
            });

            socket.on('disconnect', () => {
                console.log('Desconectado do servidor Socket.IO');
                document.getElementById('connection-status').innerHTML = 
                    '<i class="fas fa-exclamation-triangle mr-2"></i> Desconectado do servidor - tentando reconectar...';
            });

            socket.on('connect_error', (err) => {
                console.error('Erro de conexão:', err);
                document.getElementById('connection-status').innerHTML = 
                    '<i class="fas fa-exclamation-triangle mr-2"></i> Erro de conexão: ' + err.message;
            });

            // Handler para receber o QR Code
            socket.on('qr', (url) => {
                console.log('QR Code recebido:', url ? 'imagem recebida' : 'null');
                const qrImg = document.getElementById('qrcode');
                const statusDiv = document.getElementById('connection-status');
                
                if (url) {
                    qrImg.src = url;
                    qrImg.classList.remove('hidden');
                    statusDiv.innerHTML = '<i class="fas fa-qrcode mr-2"></i> Escaneie o QR Code no WhatsApp';
                    statusDiv.className = 'mb-4 p-3 rounded-lg bg-blue-100 text-blue-800 text-center';
                } else {
                    qrImg.classList.add('hidden');
                }
            });

            // Handler para atualizações de status
            socket.on('status', (message) => {
                console.log('Status atualizado:', message);
                const statusDiv = document.getElementById('connection-status');
                statusDiv.innerHTML = `<i class="fas fa-info-circle mr-2"></i> ${message}`;
                
                if (message.includes('Conectado')) {
                    statusDiv.className = 'mb-4 p-3 rounded-lg bg-green-100 text-green-800 text-center';
                } else if (message.includes('Desconectado') || message.includes('Erro')) {
                    statusDiv.className = 'mb-4 p-3 rounded-lg bg-red-100 text-red-800 text-center';
                } else {
                    statusDiv.className = 'mb-4 p-3 rounded-lg bg-blue-100 text-blue-800 text-center';
                }
            });

            // Solicita o QR Code novamente se não receber em 3 segundos
            setTimeout(() => {
                if (!document.getElementById('qrcode').src) {
                    console.log('Solicitando QR Code...');
                    socket.emit('request_qr');
                }
            }, 3000);
        </script>
    </div>
</body>
</html>